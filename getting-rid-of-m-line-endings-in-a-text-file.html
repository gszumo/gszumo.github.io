<!DOCTYPE html>
<html lang="en">
<head>
          <title>Gregg Szumowski</title>
        <meta charset="utf-8" />
        <link href="https://gszumo.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Gregg Szumowski Full Atom Feed" />
        <link href="https://gszumo.github.io/feeds/cli.atom.xml" type="application/atom+xml" rel="alternate" title="Gregg Szumowski Categories Atom Feed" />



</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://gszumo.github.io/">Gregg Szumowski <strong></strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="https://gszumo.github.io/getting-rid-of-m-line-endings-in-a-text-file.html" rel="bookmark"
         title="Permalink to "Getting Rid of ^M Line Endings in a Text File"">"Getting Rid of ^M Line Endings in a Text File"</a></h2>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2017-10-30T22:01:00-05:00">
      Mon 30 October 2017
    </time>
    <address class="vcard author">
      By           <a class="url fn" href="https://gszumo.github.io/author/gregg-szumowski.html">Gregg Szumowski</a>
    </address>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>If you have a text file that has funny looking ^M characters at the end of each line, in most cases, you have to get rid of them before they can be used. This is especially the case when you've copied or transferred a file from a Windows-based system to a <em>nix-based one. If these files are shell scripts meant to run on the </em>nix-based system they more often than not won't work. There are various solutions to this problem.</p>
<p>First, let's create two text files: one with ^M line endings and one without:</p>
<div class="highlight"><pre><span></span>$ <span class="k">for</span> line in <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span><span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="s2">&quot;This is line </span><span class="si">${</span><span class="nv">line</span><span class="si">}</span><span class="s2">^M&quot;</span> &gt;&gt;file1.txt<span class="p">;</span> <span class="k">done</span>
$ <span class="k">for</span> line in <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span><span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="s2">&quot;This is line </span><span class="si">${</span><span class="nv">line</span><span class="si">}</span><span class="s2">&quot;</span> &gt;&gt;file2.txt<span class="p">;</span> <span class="k">done</span>
</pre></div>


<p>Now let's see what's different between these two text files:</p>
<div class="highlight"><pre><span></span>$ ls -l
total <span class="m">8</span>
-rw-rw-r--. <span class="m">1</span> gszumo gszumo <span class="m">80</span> Oct <span class="m">29</span> <span class="m">17</span>:43 file1.txt
-rw-rw-r--. <span class="m">1</span> gszumo gszumo <span class="m">75</span> Oct <span class="m">29</span> <span class="m">17</span>:44 file2.txt

$ file file1.txt
file1.txt: ASCII text, with CRLF line terminators

$ file file2.txt
file2.txt: ASCII text

$ diff file1.txt file2.txt
<span class="m">1</span>,5c1,5
&lt; This is line <span class="m">1</span>
&lt; This is line <span class="m">2</span>
&lt; This is line <span class="m">3</span>
&lt; This is line <span class="m">4</span>
&lt; This is line <span class="m">5</span>
---
&gt; This is line <span class="m">1</span>
&gt; This is line <span class="m">2</span>
&gt; This is line <span class="m">3</span>
&gt; This is line <span class="m">4</span>
&gt; This is line <span class="m">5</span>
$
</pre></div>


<p>What does this tell us?</p>
<ul>
<li>The ls command tells us the file sizes are different even though the visible text is the same.</li>
<li>The file command tells us that both files are ASCII text  but file1.txt has CRLF line terminators, and</li>
<li>The diff command tells us that each line is indeed showing us that it's different.</li>
</ul>
<p>So, how do we fix this?</p>
<p><img alt="alt text" src="/images/file1-txt.png" title="Screen shot image"></p>
<p>My favorite solution is to use vi or vim interactively. There are 2 easy ways to get rid of the ^M from a single file using vim:</p>
<ol>
<li>Enter the command:
<code>:%s/^M//g</code>
on the vim command line then save the file, or</li>
<li>Enter the command:
<code>:fileformat=unix</code>
on the vim command line and save the file.</li>
</ol>
<p>However, if you have a whole directory or directory tree full of these kinds of files using vim on each one individually will become quite tedious. For this you need the scripting capability of the command line!</p>
<p>The 'tr' command is one quick way of getting rid of them using the Linux or macOS command line:</p>
<div class="highlight"><pre><span></span>cat somefile | tr -d &#39;^M&#39; &gt;outputfile
</pre></div>


<p>We can use this as a template in order to determine whether or not the file needs to be updated:</p>
<div class="highlight"><pre><span></span>for i in *
do
  string=$(file <span class="cp">${</span><span class="n">i</span><span class="cp">}</span>)
  test &quot;<span class="cp">${</span><span class="n">string</span><span class="c1">#*&#39;CRLF&#39;</span><span class="cp">}</span>&quot; != &quot;<span class="nv">$string</span>&quot; <span class="err">&amp;&amp;</span> echo &quot;CRLF found in <span class="cp">${</span><span class="n">i</span><span class="cp">}</span>&quot;
done
</pre></div>


<p>If the 'echo' part of this snippet only gets called when the first part of the test is true, so then we know that the file has '^M' line endings. We have to turn the second part of the test into a script that will massage the file to remove the line endings. Here's a bash snippet that will put the two together and do the job:</p>
<div class="highlight"><pre><span></span>for i in *
do
  string=$(file <span class="cp">${</span><span class="n">i</span><span class="cp">}</span>)
  if [ &quot;<span class="cp">${</span><span class="n">string</span><span class="c1">#*&#39;CRLF&#39;</span><span class="cp">}</span>&quot; != &quot;<span class="nv">$string</span>&quot; ];then
    cp <span class="cp">${</span><span class="n">i</span><span class="cp">}</span> <span class="cp">${</span><span class="n">i</span><span class="cp">}</span>.bak
    cat <span class="cp">${</span><span class="n">i</span><span class="cp">}</span>.bak|tr -d &#39;^M&#39; &gt;<span class="cp">${</span><span class="n">i</span><span class="cp">}</span>
    rm <span class="cp">${</span><span class="n">i</span><span class="cp">}</span>.bak
  fi
done
</pre></div>


<p>This is a bare-bones piece of code which doesn't do any error checking, which should be added in the event that the user running this script doesn't have the necessary permissions to copy, write or remove files that match the test.</p>
<p>Remember, in order to create a '^M' character in the terminal hold down the CTRL key while  typing vm.</p>
<p>You can also use 'ex' to replace a string in a file using:</p>
<div class="highlight"><pre><span></span>ex -s -c &#39;%s/old-str/new-str/g|x&#39; filename.txt
</pre></div>


<p>Alternately, we can use sed to do the same thing. At the command line you can replace any string in a file dynamically by entering:</p>
<div class="highlight"><pre><span></span>sed -i &#39;s/old-str/new-str/&#39; filename.txt
</pre></div>


<p>So to remove the ^M charaters just do:</p>
<div class="highlight"><pre><span></span>sed -i &#39;s/^M//&#39; filename.txt
</pre></div>


<p>to remove the ^M characters. You can use the same for/do/done loop structure as mentioned above to iterate over multiple files:</p>
<div class="highlight"><pre><span></span>for i in *.txt
do
  sed -i &#39;s/^M//&#39; <span class="cp">${</span><span class="n">i</span><span class="cp">}</span>
done
</pre></div>


<p>'Nuff said.</p>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>